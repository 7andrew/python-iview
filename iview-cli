#!/usr/bin/env python

import sys, getopt, urllib2
import iview.comm
import iview.fetch

def usage():
	print("""usage:
	-d, --download <url>	download a program
	-p, --programme		print the iView programme (URL in parentheses)
	-a, --print-auth	print iView auth information (for debugging purposes)
	-h, --help		this page""")

def config():
	try:
		iview.comm.get_config()
	except urllib2.HTTPError, error:
		print 'Error: could not retrieve an important configuration file from iView.'
		print 'Please make sure you are connected to the Internet.\n'
		print 'If iView works fine in your web browser, the iView API has possibly changed.' \
		      'Try to find an updated version of this program or contact the author.'
		print '\nDebug: could not load URL', error.url
		sys.exit(1)

def programme():
	config()
	iview.comm.get_programme()

	from iview import programme
	series = programme.get_iter_root()
	while not series is None:
		print(programme.get(series, 0)[0] + ':')

		# Remove initial "Loading..." item
		item = programme.iter_children(series)
		programme.remove(item)

		iview.comm.get_series_items(series)
		item = programme.iter_children(series)
		while not item is None:
			print('\t' + programme.get(item, 0)[0] + '\t(' + programme.get(item, 2)[0] + ')')
			item = programme.iter_next(item)
		series = programme.iter_next(series)

def print_auth():
	auth = iview.comm.get_auth()
	print 'iView auth data:'
	print '\tToken:', auth['token']
	print '\tRTMP URL:', auth['rtmp_url']
	print '\tUnmetered:', str(auth['free'])

def download(url):
	config()
	iview.fetch.fetch_program(url, execvp=True)

try:
	opts, args = getopt.getopt(sys.argv[1:], 'cd:pah', ['cache', 'download=', 'programme', 'program', 'print-auth', 'help'])
	if not len(opts) > 0:
		raise getopt.GetoptError('Not enough arguments')
except getopt.GetoptError, err:
	usage()
	sys.exit(2)

for o, a in opts:
	if o in ('-c', '--cache'):
		iview.comm.cache = True
	if o in ('-p', '--programme', '--program'):
		try:
			programme()
		except KeyboardInterrupt: # don't traceback on a Ctrl+C
			pass
	elif o in ('-a', '--print-auth'):
		print_auth()
	elif o in ('-d', '--download'):
		download(a)
	elif o in ('-h', '--help'):
		usage()
		sys.exit(2)

