#!/usr/bin/env python

import sys, getopt
import iview

def usage():
	print("""usage:
	-d, --download <url>	download a program
	-p, --programme		print the iView programme (URL in parentheses)
	-a, --print-auth	print iView auth information (for debugging purposes)
	-h, --help		this page""")

def programme():
	iview.do_handshake()
	iview.get_programme()

	from iview import programme
	channel = programme.get_iter_root()
	while not channel is None:
		print(programme.get(channel, 0)[0] + ':')
		program = programme.iter_children(channel)
		while not program is None:
			print('\t' + programme.get(program, 0)[0] + '\t(' + programme.get(program, 1)[0] + ')')
			program = programme.iter_next(program)
		channel = programme.iter_next(channel)

def print_auth():
	iview.do_handshake()

	auth = iview.comm.get_auth()
	print 'iView auth data:'
	print '\tToken:', auth['token']
	print '\tRTMP URL:', auth['rtmp_url']
	print '\tUnmetered:', str(auth['free'])

def download(url):
	iview.do_handshake()
	iview.fetch_program(url, execvp=True)

try:
	opts, args = getopt.getopt(sys.argv[1:], 'cd:pah', ['cache', 'download=', 'programme', 'program', 'print-auth', 'help'])
	if not len(opts) > 0:
		raise getopt.GetoptError('Not enough arguments')
except getopt.GetoptError, err:
	usage()
	sys.exit(2)

for o, a in opts:
	if o in ('-c', '--cache'):
		iview.comm.cache = True
	if o in ('-p', '--programme', '--program'):
		programme()
	elif o in ('-a', '--print-auth'):
		print_auth()
	elif o in ('-d', '--download'):
		download(a)
	elif o in ('-h', '--help'):
		usage()
		sys.exit(2)

