#!/usr/bin/env python

import iview
import gtk
import gobject
import threading
import sys

class Bootstrapper(threading.Thread):

	def run(self):
		global status

		self.update_progress(0.0, 'Performing handshake')
		iview.do_handshake()
		iview.get_programme(self.update_progress)

		gtk.gdk.threads_enter()
		populate_programme()
		gtk.gdk.threads_leave()

	def stop(self):
		pass

	def update_progress(self, amount=None, message=''):
		gtk.gdk.threads_enter()
		programme_status.update_progress(amount, message)
		gtk.gdk.threads_leave()

class Splash(gtk.Window):
	def __init__(self):
		gtk.Window.__init__(self)

		self.set_border_width(10)
		self.set_resizable(False)

		self.progressbar = gtk.ProgressBar()
		self.add(self.progressbar)

	def update_progress(self, amount=None, message=''):
		if amount == None:
			status.set_fraction(0.0)
			status.set_text('')
		else:
			amount = self.progressbar.get_fraction() + amount
			if amount > 1.0:
				amount = 1.0
			self.progressbar.set_fraction(amount)
			self.progressbar.set_text(message)

def populate_programme():
	programme_status.destroy()

	treestore = gtk.TreeStore(str, str)
	for channel in iview.comm.programme.iteritems():
		c = treestore.append(None, [channel[0], False])
		for program in channel[1]:
			treestore.append(c, [program['title'], program['url']])

	tvcolumn = gtk.TreeViewColumn('Program Name')
	listing.append_column(tvcolumn)
	cell = gtk.CellRendererText()
	tvcolumn.pack_start(cell, True)
	tvcolumn.add_attribute(cell, 'text', 0)

	listing.set_model(treestore)

	window.show_all()

gtk.gdk.threads_init()

window = gtk.Window()
window.set_title('iView')
window.set_border_width(10)
window.set_default_size(300,450)
window.connect('destroy', gtk.main_quit)

vbox = gtk.VBox()

programme_label = gtk.Label()
programme_label.set_markup("<big><b>iView Programme</b></big>")
vbox.pack_start(programme_label, expand=False)

listing_scroller = gtk.ScrolledWindow()
listing_scroller.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)

listing = gtk.TreeView(None)
listing.set_headers_visible(False)

listing_scroller.add(listing)
vbox.pack_start(listing_scroller)

window.add(vbox)

programme_status = Splash()
programme_status.set_title("iView Loading")
programme_status.show_all()

if sys.argv[1] in ('-c', '--cache'):
	iview.comm.cache = True

Bootstrapper().start()
gtk.main()
